# Polis CLI - Complete Usage Guide

> This is the comprehensive command reference. For a quick introduction, see [README.md](README.md).

Command-line tool for managing decentralized social content with cryptographic signing and version control.

## Overview

The Polis CLI enables authors to:
- Create and sign posts and comments using Ed25519 cryptography
- Manage content with git-based version history
- Publish content as static files with frontmatter metadata
- Render markdown to static HTML with customizable templates
- Request blessings from discovery services for authenticated comment discovery
- Automate workflows with JSON mode for scripting and CI/CD integration

## Installation

### Prerequisites

- **OpenSSH 8.0+** (for Ed25519 signing with `-Y` flag)
- **jq** (JSON processor for index management and JSON mode)
- **curl** (for API communication with discovery service)
- **sha256sum** or **shasum** (for content hashing)
- **git** (optional, for version control integration)
- **pandoc** (optional, required only for `polis render` command)

### Install Dependencies

```bash
# Linux (Debian/Ubuntu)
sudo apt-get install openssh-client jq curl coreutils git
sudo apt-get install pandoc  # Optional: for polis render

# macOS
brew install openssh jq curl coreutils git
brew install pandoc  # Optional: for polis render
```

### Install Polis CLI

```bash
# Option 1: Add to PATH
export PATH="/path/to/polis-planning/cli/bin:$PATH"

# Option 2: Create symlink
sudo ln -s /path/to/polis-planning/cli/bin/polis /usr/local/bin/polis

# Verify installation
polis --help
```

## Quick Start

This example demonstrates a complete workflow: creating a post, commenting on it, and managing blessing requests.

```bash
# 1. Initialize a new Polis directory
mkdir my-blog && cd my-blog
polis init

# 2. Set up environment variables (required for blessing workflow)
export POLIS_BASE_URL="https://yourdomain.com"
export POLIS_DISCOVERY_ENDPOINT="https://xxx.supabase.co/functions/v1"

# 3. Create a post
cat > posts/hello.md << 'EOF'
# Hello World

This is my first post on Polis!
EOF

# 4. Publish the post
polis publish posts/hello.md

# 5. Create a comment on the post
cat > comments/reply.md << 'EOF'
# Great post!

I really enjoyed reading this. Looking forward to more!
EOF

# 6. Comment on your own post (to test the blessing workflow)
polis comment comments/reply.md ${POLIS_BASE_URL}/posts/$(date +%Y%m%d)/hello.md

# 7. View pending blessing requests
polis blessing requests

# 8. Grant the blessing (using the comment hash from step 7)
polis blessing grant <comment-hash>

# Alternatively, deny a blessing:
# polis blessing deny <comment-hash>

# 9. Set up git for your content
git init
git add .
git commit -m "Initial post and comment"

# 10. Push to your static host (GitHub Pages, Netlify, etc.)
git push origin main
```

**What happens in this workflow:**
- Step 4: Post is published and added to `public.jsonl` index
- Step 6: Comment is created, automatically requests blessing from discovery service
- Step 7: Lists all pending comments awaiting your approval
- Step 8: Approving the comment makes it visible in the discovery service
- Once blessed, readers can discover your comment when querying the post

**Note:** In practice, step 6 would typically be someone else commenting on your post from their own Polis instance. This example shows you commenting on your own post for testing purposes.

## Directory Structure

After running `polis init`, your directory will contain:

```
.
├── .polis/
│   ├── keys/
│   │   ├── id_ed25519       # Private signing key (keep secret!)
│   │   └── id_ed25519.pub   # Public verification key
│   └── themes/              # Installed themes
│       ├── turbo/           # Retro computing theme
│       │   ├── index.html
│       │   ├── post.html
│       │   ├── comment.html
│       │   ├── comment-inline.html
│       │   ├── turbo.css
│       │   └── snippets/
│       ├── zane/            # Neutral dark theme
│       └── sols/            # Nine Sols inspired theme
├── metadata/                 # Metadata files
│   ├── public.jsonl         # Content index (JSONL format)
│   ├── snippets.jsonl       # Snippet index (JSONL format)
│   ├── blessed-comments.json # Index of approved comments
│   ├── manifest.json        # Site metadata (active_theme, site_title)
│   └── following.json       # Following list
├── posts/                    # Your posts
│   └── 20260106/            # Date-stamped directory (YYYYMMDD)
│       ├── .versions/       # Version history for posts in this directory
│       │   └── my-post.md
│       ├── my-post.md
│       └── my-post.html     # Generated by polis render
├── comments/                 # Your comments
│   └── 20260106/            # Date-stamped directory (YYYYMMDD)
│       ├── .versions/       # Version history for comments in this directory
│       │   └── reply.md
│       ├── reply.md
│       └── reply.html       # Generated by polis render
├── snippets/                 # Global snippets (override theme snippets)
│   └── about.md             # Custom about section
├── styles.css               # Active theme's stylesheet (copied on render)
├── index.html               # Site index (generated by polis render)
└── .well-known/
    └── polis                # Public metadata (author, public key)
```

## Commands

### `polis init`

Initialize a new Polis directory with keys and metadata.

```bash
polis init
polis init --site-title "My Awesome Blog"
```

**Options:**
- `--site-title <title>` - Set a custom site title for branding (optional)
- `--posts-dir <dir>` - Custom posts directory (default: `posts`)
- `--comments-dir <dir>` - Custom comments directory (default: `comments`)
- `--keys-dir <dir>` - Custom keys directory (default: `.polis/keys`)
- `--themes-dir <dir>` - Custom themes directory (default: `.polis/themes`)

**Creates:**
- `.polis/keys/` - Ed25519 keypair for signing
- `.polis/themes/` - Installed themes (turbo, zane, sols)
- `posts/`, `comments/` - Content directories
- `metadata/` - Metadata directory
- `.well-known/polis` - Public metadata file
- `metadata/public.jsonl` - Content index (JSONL format)
- `metadata/blessed-comments.json` - Blessed comments index
- `metadata/following.json` - Following list
- `metadata/manifest.json` - Site metadata (includes `site_title` if provided)

### `polis publish <file>`

Sign and publish a post or comment with frontmatter metadata.

```bash
polis publish posts/my-post.md
polis publish comments/my-comment.md
```

**What it does:**
1. Generates SHA-256 hash of content
2. Signs content with Ed25519 private key
3. Adds frontmatter with metadata (version, author, signature)
4. Appends entry to `public.jsonl` index
5. Creates `.versions` file for version history

**Example output:**
```
[i] Content hash: sha256:a3b5c7d9...
[i] Signing content with Ed25519 key...
[✓] Created canonical file: posts/20260106/my-post.md
```

### `polis republish <file>`

Republish an existing file with updated content (creates new version).

```bash
# Edit your published file
vim posts/20260106/my-post.md

# Republish with new version
polis republish posts/20260106/my-post.md
```

**What it does:**
1. Generates diff between old and new content
2. Appends diff to `.versions` file
3. Updates frontmatter with new version hash
4. Re-signs content with new signature
5. Rebuilds `public.jsonl` index (prevents duplicates)

**Version history:**
- Stored in `.versions/` subdirectory alongside content files
- Example: `posts/20260106/my-post.md` → `posts/20260106/.versions/my-post.md`
- Directory name configurable via `POLIS_VERSIONS_DIR_NAME` (default: `.versions`)
- Uses unified diff format (compatible with `diff`/`patch` tools)
- Enables version reconstruction

### `polis snippet <file>`

Sign and publish a reusable template snippet.

```bash
# Publish a snippet from file
polis snippet snippets/homepage/about.md

# Publish from stdin
echo "Welcome to my site!" | polis snippet -
cat about.md | polis snippet --stdin

# With custom filename (when using stdin)
echo "Hello" | polis snippet - --filename homepage/greeting.html

# JSON mode
polis snippet snippets/partials/header.html --json
```

**What it does:**
1. Signs the snippet content with Ed25519 private key
2. Adds frontmatter with metadata (title, published, version, signature)
3. Appends entry to `metadata/snippets.jsonl` index

**Snippets vs Themes:**
- **Snippets** are signed content fragments stored in `snippets/` (global) or theme directories
- **Themes** are complete styling packages stored in `.polis/themes/`
- Snippets can be included in templates using `{{> path/to/snippet}}`
- Snippet lookup order: theme snippets first, then global snippets

**File formats:**
- `.md` files are processed through pandoc (markdown → HTML)
- `.html` files are used as-is

**Example snippet (`snippets/homepage/about.md`):**
```markdown
---
title: About Section
published: 2026-01-15T12:00:00Z
version: sha256:abc123...
signature: -----BEGIN SSH SIGNATURE-----...
---

Hi, I'm Vincent. I build things with code and think deeply about
how technology shapes human connection.
```

### Publishing from stdin

You can pipe content directly to `polis publish` and `polis comment` without creating temporary files:

```bash
# Basic usage
echo "# My Post" | polis publish -

# Specify filename
echo "# My Post" | polis publish - --filename my-post.md

# Specify title
echo "Content without heading" | polis publish - --title "My Title"

# Both options
echo "Content" | polis publish - --filename post.md --title "My Title"

# From file redirect
polis publish - < draft.md

# From curl
curl -s https://example.com/draft.md | polis publish -

# From heredoc
polis publish - << 'EOF'
# My Post
Content here
EOF

# Piping with preprocessing
grep -v "^Draft:" draft.md | polis publish - --filename final.md
```

**Options:**
- `--filename <name>` - Specify output filename (default: `stdin-TIMESTAMP.md`)
- `--title <title>` - Override title extraction

**For comments:**
```bash
# Comment from stdin
echo "# My reply" | polis comment - https://bob.com/posts/original.md

# With filename
echo "# Reply" | polis comment - https://bob.com/post.md --filename my-reply.md

# With title override
echo "Content" | polis comment - https://bob.com/post.md --title "My Reply"
```

**JSON mode:**
```bash
echo "# Test" | polis --json publish - --filename test.md | jq
```

### `polis comment <url> [file]`

Create a comment in reply to a post or another comment (nested threads).

```bash
# Reply to a post
polis comment https://alice.example.com/posts/20260106/hello.md

# Reply to another comment (nested thread)
polis comment https://bob.example.com/comments/20260105/reply.md my-reply.md

# From file
polis comment https://bob.example.com/posts/intro.md my-reply.md
```

**What it does:**
1. Creates comment file in `comments/YYYYMMDD/`
2. Adds `in_reply_to` frontmatter (with `url` and `root-post` fields)
3. Signs and publishes comment
4. Appends entry to `public.jsonl` index
5. Automatically requests blessing from discovery service

**Nested threads:** When replying to a comment (instead of a post), the CLI automatically detects this and fetches the original post URL (`root-post`) from the discovery service.

**Frontmatter structure:**
```yaml
in-reply-to:
  url: https://bob.com/comments/reply.md  # Immediate parent (post or comment)
  root-post: https://alice.com/posts/intro.md  # Always the original post
```

### `polis preview <url>`

Preview content at a URL (posts or comments) with signature verification.

```bash
# Preview a post
polis preview https://alice.com/posts/20260105/hello.md

# Preview a comment before blessing it
polis preview https://bob.com/comments/20260105/reply.md

# JSON mode for scripting
polis --json preview https://alice.com/posts/hello.md
```

**What it shows:**
- Frontmatter metadata (displayed dimmed/greyed)
- Signature verification status (valid/invalid/missing)
- Content hash verification (valid/mismatch)
- For comments: the in-reply-to URL
- The content body

**Use cases:**
- Preview a comment before blessing it
- Preview content before responding to it
- Verify content integrity and authenticity

**JSON mode output:**
```json
{
  "status": "success",
  "command": "preview",
  "data": {
    "url": "https://alice.com/posts/hello.md",
    "type": "post",
    "title": "Hello World",
    "published": "2026-01-05T12:00:00Z",
    "current_version": "sha256:abc123...",
    "generator": "polis-cli/0.2.0",
    "in_reply_to": null,
    "author": "alice@example.com",
    "signature": {
      "status": "valid",
      "message": "Signature verified against author's public key"
    },
    "hash": {
      "status": "valid"
    },
    "validation_issues": [],
    "body": "# Hello World\n\nThis is my first post..."
  }
}
```

### `polis rebuild [--diff|--full]`

Rebuild the `public.jsonl` index from all published files. Optionally sync `blessed-comments.json` from the discovery service.

```bash
# Rebuild content index only (default)
polis rebuild

# Also sync missing blessed comments (incremental)
polis rebuild --diff

# Rebuild blessed-comments.json entirely from database
polis rebuild --full
```

**Flags (mutually exclusive):**
- `--diff` - Adds any blessed comments from the discovery service that are missing locally
- `--full` - Truncates and rebuilds `blessed-comments.json` entirely from the discovery service

**Use when:**
- Index is corrupted or out of sync
- You manually edited published files
- You restored from backup
- `--diff`: Sync blessings after being offline
- `--full`: Reset blessing state to match server exactly

### `polis index [--json]`

View the content index in JSONL or JSON format (read-only, outputs to stdout).

```bash
# View as JSONL (default)
polis index

# View as JSON (grouped by type)
polis index --json

# Pipe to jq for pretty printing
polis index --json | jq

# Count posts
polis index | grep -c '"type":"post"'

# View recent 10 entries
polis index | tail -10 | jq

# Extract all post titles
polis index --json | jq -r '.posts[].title'
```

**What it does:**
- Reads `metadata/public.jsonl`
- Default: outputs raw JSONL (one entry per line)
- `--json` flag: converts to grouped JSON format for readability
- Read-only operation - never modifies the index file

**Use cases:**
- Debugging index contents
- Scripting and automation
- Inspecting published content metadata

### `polis extract <file> <version-hash>`

Reconstruct a specific version of a file from version history.

```bash
# Get specific version
polis extract posts/20260106/my-post.md sha256:abc123...

# Output to file
polis extract posts/20260106/my-post.md sha256:abc123... > old-version.md
```

### Starting Fresh

To completely reset your Polis installation and start over, move or remove the following files/directories, then run `polis init`:

- `.polis/` - Configuration and signing keys
- `.well-known/` - Public metadata
- `posts/` - Published posts
- `comments/` - Published comments
- `metadata/` - Index and blessing data

**Example:**
```bash
rm -rf .polis .well-known posts comments metadata
polis init
```

**Note:** This will generate new signing keys. If you want to keep your identity, back up `.polis/keys/` before removing.

### `polis migrate <new-domain>`

Migrate all content to a new domain. This command handles the complete migration process including re-signing files and updating the discovery service database.

```bash
polis migrate newdomain.com
```

**What it does:**
1. Auto-detects current domain from published files
2. Updates `canonical_url` in all posts and comments
3. Updates `in_reply_to` and `root_post` URLs (only for own content)
4. Re-signs all files with new URLs
5. Updates `metadata/blessed-comments.json`
6. Updates `.well-known/polis` endpoints
7. Rebuilds `metadata/public.jsonl` index
8. Updates discovery service database (preserves blessing status)
9. Stages all changes in git

**Example output:**
```
[i] Detected current domain: olddomain.com
[i] New domain: newdomain.com

Continue with migration? (y/N) y

[i] Updating posts...
[i] Updating comments...
[i] Updating blessed-comments.json...
[i] Updating .well-known/polis...
[i] Rebuilding public.jsonl index...
[i] Updating discovery service database...
[✓] Database migration complete (5 rows updated)
[✓] Staged all changes in git

[✓] Migration complete!

Old domain: olddomain.com
New domain: newdomain.com
Posts updated: 3
Comments updated: 5
Database rows updated: 5

Next steps:
1. Deploy to new domain
2. Set up redirect from old domain (recommended)
3. Update POLIS_BASE_URL environment variable
```

**JSON mode:**
```bash
polis --json migrate newdomain.com | jq
```

**JSON output:**
```json
{
  "status": "success",
  "command": "migrate",
  "data": {
    "old_domain": "olddomain.com",
    "new_domain": "newdomain.com",
    "posts_updated": 3,
    "comments_updated": 5,
    "database_updated": true,
    "database_rows": 5
  }
}
```

**Important notes:**
- Domain should not include protocol (use `example.com`, not `https://example.com`)
- Comments you made on others' posts will have their `in_reply_to`/`root_post` preserved (pointing to the other author's domain)
- The discovery service database update requires `POLIS_ENDPOINT_BASE` and `DISCOVERY_SERVICE_KEY` to be configured
- If database update fails, local migration still succeeds - you can re-beseech comments later

### `polis version`

Print the CLI version number.

```bash
polis version
```

**Example output:**
```
polis 0.22.0
```

### `polis about`

Display branded information about Polis including version numbers and project links.

```bash
polis about
```

**Example output:**
```
Polis - Decentralized Social Networking
Your content, free from platform control

────────────────────────────────────────
  CLI version:          0.22.0
  Site version:         0.22.0
  Following version:    0.1.0
  Blessings version:    0.1.0

  Your site:            https://example.com
────────────────────────────────────────
  Project:  https://github.com/anthropics/polis
  License:  AGPL v3
```

**Note:** This command is human-readable only. For scripted access to configuration, use `polis config --json`.

### `polis config`

Display current configuration including CLI version, environment variables, directory paths, and key information.

```bash
# Human-readable output
polis config

# JSON output for scripting
polis --json config
polis config --json
```

**Example output:**
```
Polis Configuration
════════════════════════════════════════

CLI
  Version:              0.22.0

Environment
  POLIS_BASE_URL:       https://example.com
  POLIS_ENDPOINT_BASE:  https://xxx.supabase.co/functions/v1
  DISCOVERY_SERVICE_KEY: [set]

Directories
  Keys:                 .polis/keys
  Posts:                posts
  Comments:             comments
  Versions:             .versions

Files
  Public index:         metadata/public.jsonl
  Blessed comments:     metadata/blessed-comments.json
  Following:            metadata/following.json

Keys
  Status:               initialized
  Fingerprint:          SHA256:abc123...
```

**JSON mode:** See [JSON-MODE.md](JSON-MODE.md) for the full JSON response format.

### `polis render [--force]`

Render markdown posts and comments to static HTML files using pandoc.

```bash
# Render all posts and comments (skips up-to-date files)
polis render

# Force re-render all files
polis render --force
```

**What it does:**
1. On first render, automatically selects a theme from available themes
2. Converts all markdown files in `posts/` and `comments/` to HTML
3. Uses pandoc for markdown-to-HTML conversion
4. Applies theme templates with metadata substitution
5. Embeds blessed comments directly in post HTML files
6. Copies theme CSS to `styles.css` at site root
7. Generates an `index.html` listing all posts
8. Skips files where HTML is newer than markdown (unless `--force`)

**Requires:** pandoc (install with `apt install pandoc` or `brew install pandoc`)

**Generated files:**
- `posts/YYYYMMDD/my-post.html` - Rendered post with embedded blessed comments
- `comments/YYYYMMDD/my-comment.html` - Rendered comment
- `index.html` - Site index listing all posts

**Example output:**
```
=== Render Configuration ===
[i] POLIS_BASE_URL: https://example.com
[i] Posts dir: posts
[i] Comments dir: comments
[i] Blessed comments: 2 post(s) with blessed comments

=== Rendering Posts ===
Processing: posts/20260106/hello.md
  -> Rendered: posts/20260106/hello.html

=== Rendering Comments ===
Processing: comments/20260106/reply.md
  -> Rendered: comments/20260106/reply.html

=== Generating Index ===
Generated: index.html

[✓] Rendering complete!
[i]   Posts rendered: 1 (skipped: 0)
[i]   Comments rendered: 1 (skipped: 0)
[i]   Index: index.html
```

#### Theme Selection

Polis ships with three themes (turbo, zane, sols). On first render, a theme is randomly selected. To change themes:

1. Edit `metadata/manifest.json` and set `active_theme`:
   ```json
   {
     "active_theme": "zane"
   }
   ```

2. Re-render with `polis render --force`

#### Theme Customization

Create a custom theme by copying an existing one:

```bash
cp -r .polis/themes/turbo .polis/themes/custom
mv .polis/themes/custom/turbo.css .polis/themes/custom/custom.css
```

Each theme contains:

**Templates** in `.polis/themes/{name}/`:
- `index.html` - Site index template
- `post.html` - Post page template
- `comment.html` - Comment page template
- `comment-inline.html` - Blessed comment template

**Snippets** in `.polis/themes/{name}/snippets/`:
- `about.html` - About section
- `post-item.html` - Post list item (used in `{{#posts}}` loops)
- `comment-item.html` - Comment list item (used in `{{#comments}}` loops)
- `blessed-comment.html` - Blessed comment (used in `{{#blessed_comments}}` loops)

**Global snippets** in `snippets/` override theme snippets.

**Template variables:**

| Variable | Description |
|----------|-------------|
| `{{title}}` | Post/comment title |
| `{{content}}` | HTML-rendered body content |
| `{{published}}` | Publication date (ISO format) |
| `{{published_human}}` | Publication date (human-readable) |
| `{{url}}` | Canonical URL |
| `{{version}}` | Content hash |
| `{{signature_short}}` | Truncated signature |
| `{{site_title}}` | Site domain name |
| `{{site_url}}` | Full site URL |
| `{{author_name}}` | Author name from .well-known/polis |
| `{{author_url}}` | Author's base URL |
| `{{blessed_count}}` | Number of blessed comments (posts only) |
| `{{in_reply_to_url}}` | Parent URL (comments only) |
| `{{root_post_url}}` | Original post URL (comments only) |
| `{{post_count}}` | Number of posts (index only) |
| `{{year}}` | Current year |

**Mustache syntax:**

| Syntax | Description |
|--------|-------------|
| `{{> path/to/snippet}}` | Include a snippet |
| `{{#posts}}...{{/posts}}` | Loop over posts |
| `{{#comments}}...{{/comments}}` | Loop over comments |
| `{{#blessed_comments}}...{{/blessed_comments}}` | Loop over blessed comments |

**Example template with loops:**
```html
<section class="posts">
{{#posts}}
    {{> partials/post-item}}
{{/posts}}
</section>
```

Edit these templates and snippets to customize the HTML output, then run `polis render` to apply your changes.

#### Embedded Source

Each rendered HTML file includes the original markdown source and frontmatter in an HTML comment at the end of the file:

```html
<!--
=== POLIS SOURCE ===
Source: posts/20260106/hello.md
title: Hello World
published: 2026-01-06T12:00:00Z
current-version: abc123...
signature: AAAAB3NzaC1...
---
This is my first post!
=== END POLIS SOURCE ===
-->
```

This enables:
- Verification that the HTML matches the signed source
- Extraction of original markdown from rendered HTML
- Debugging template issues by comparing source to output

**JSON mode:**
```bash
polis --json render | jq
```

**JSON output:**
```json
{
  "status": "success",
  "command": "render",
  "data": {
    "posts_rendered": 3,
    "posts_skipped": 0,
    "comments_rendered": 2,
    "comments_skipped": 1,
    "index_generated": true
  }
}
```

### `polis blessing`

Parent command for blessing-related operations. Must be followed by a subcommand.

#### `polis blessing requests`

List pending blessing requests for your posts.

```bash
polis blessing requests
```

**Example output:**
```
ID    Author              Post                    Status
42    bob@example.com     /posts/hello.md         pending
73    carol@example.com   /posts/hello.md         pending
```

#### `polis blessing grant <hash>`

Approve a pending blessing request by content hash.

```bash
polis blessing grant abc123-def456
```

**What it does:**
1. Updates discovery service status to "blessed"
2. Adds entry to `metadata/blessed-comments.json`
3. Comment becomes visible to your audience

#### `polis blessing deny <hash>`

Reject a pending blessing request by content hash.

```bash
polis blessing deny abc123-def456
```

**What it does:**
1. Updates discovery service status to "denied"
2. Comment remains on author's site but won't be amplified

#### `polis blessing beseech <hash>`

Re-request blessing for a comment by content hash (retry after changes).

```bash
polis blessing beseech abc123-def456
```

**Use when:**
- Original request failed
- You updated the comment and want to re-request

#### `polis blessing sync`

Synchronize auto-blessed comments from the discovery service to your local `blessed-comments.json`.

```bash
polis blessing sync
```

**What it does:**
1. Fetches all blessed comments for your posts from discovery service
2. Compares with local `metadata/blessed-comments.json`
3. Adds any missing entries (e.g., comments auto-blessed while you were offline)

**When to use:**
- After being offline for a while
- To ensure local file matches discovery service
- Automatically called when running `polis blessing requests`

**Example output:**
```
[i] Syncing blessed comments from discovery service...
[✓] Synced 3 comment(s) to blessed-comments.json
```

### `polis follow <author-url>`

Follow an author to auto-bless their future comments on your posts.

```bash
polis follow https://alice.example.com
```

**What it does:**
1. Adds author to `metadata/following.json`
2. Auto-blesses any existing pending comments from this author
3. Future comments from this author are automatically blessed

**Example output:**
```
[OK] Following alice.example.com
[OK] 3 existing comments auto-blessed
```

### `polis unfollow <author-url>`

Stop following an author and hide all their comments.

```bash
polis unfollow https://alice.example.com
```

**What it does:**
1. Removes author from `metadata/following.json`
2. Removes all blessed comments from this author (nuclear option)

**Warning:** This is a destructive action - all previously blessed comments from this author will be hidden.

### Auto-Blessing

Comments can be automatically blessed (no manual approval required) in two scenarios:

**1. Global Trust (Following)**
When you follow an author, ALL their future comments on ANY of your posts are auto-blessed.

```bash
# Follow Alice - all her comments on your posts are now auto-blessed
polis follow https://alice.example.com
```

**2. Thread-Specific Trust**
When you manually bless a comment from an author, their future comments *on the same post* are auto-blessed. This allows trust to be scoped to specific conversations.

```
Example:
1. Bob comments on your "Intro to Polis" post
2. You bless Bob's comment (polis blessing grant 123)
3. Bob comments again on "Intro to Polis" → auto-blessed!
4. Bob comments on your "Advanced Polis" post → NOT auto-blessed (different post)
```

**Precedence:** Global trust (following) takes priority. If you follow someone, thread-specific trust is irrelevant - they're trusted everywhere.

## File Frontmatter

Published files include YAML frontmatter with metadata:

```yaml
---
canonical_url: https://alice.example.com/posts/20260106/hello.md
version: sha256:a3b5c7d9e1f2...
author: alice@example.com
published: 2026-01-15T12:00:00Z
signature: -----BEGIN SSH SIGNATURE-----
U1NIU0lHAAAAAQA...
-----END SSH SIGNATURE-----
in_reply_to: https://bob.example.com/posts/intro.md  # Comments only
in_reply_to_version: sha256:xyz789...                # Comments only
---

# Your Content Here

The actual post or comment content follows the frontmatter.
```

## Version History

Polis uses diff-based version storage. The `.versions` file format uses standard unified diff format, making it compatible with Unix `diff` and `patch` utilities for manual inspection or reconstruction.

**Example `.versions` file:**
```
== Version 1 ==
Version: sha256:abc123...
Date: 2026-01-15T12:00:00Z

Full content of version 1...

== Version 2 ==
Version: sha256:def456...
Date: 2026-01-20T15:30:00Z
Previous: sha256:abc123...

--- old
+++ new
@@ -5,7 +5,7 @@
-This is the old line
+This is the updated line
```

## Configuration

Polis CLI uses a layered configuration system with the following precedence (highest to lowest):

1. **Environment variables** - For CI/CD and temporary overrides
2. **`.env` file** - For developer/deployment settings
3. **`.well-known/polis`** - For user-specific directory customization
4. **Built-in defaults** - Always available as fallback

### Environment Variables

```bash
# Required for blessing commands
export POLIS_BASE_URL="https://yourdomain.com"

# Discovery service (optional - has default)
export POLIS_ENDPOINT_BASE="https://xxx.supabase.co/functions/v1"

# API authentication (required for blessing operations)
export DISCOVERY_SERVICE_KEY="your-api-key"

# Optional directory overrides
export KEYS_DIR=".polis/keys"
export POSTS_DIR="posts"
export COMMENTS_DIR="comments"
export VERSIONS_DIR_NAME=".versions"
```

Add to `~/.bashrc` or `~/.zshrc` for persistence.

### Using a `.env` File

Create a `.env` file in your project root:

```bash
cp .env.example .env
# Edit .env with your settings
```

Example `.env`:
```bash
POLIS_BASE_URL=https://alice.example.com
DISCOVERY_SERVICE_KEY=eyJhbGciOiJI...
```

**Security Note:** Never commit `.env` files containing secrets. The `.env.example` file is safe to commit as a template.

### Site Title

Set a custom site title for branding in rendered HTML and comment attribution:

```bash
polis init --site-title "My Awesome Blog"
```

The site title is stored in `metadata/manifest.json` and used:
- In HTML page titles and headers (`{{site_title}}` template variable)
- When displaying your comments on other people's posts
- In `polis about` and `polis config` output

If not set, the domain from `POLIS_BASE_URL` is used as a fallback.

### Custom Directory Paths

You can customize directory paths during initialization:

```bash
polis init --posts-dir articles --comments-dir replies
polis init --site-title "My Blog" --posts-dir articles
```

Or edit the `config` section in `.well-known/polis` after initialization:

```json
{
  "version": "0.2.0",
  "config": {
    "directories": {
      "keys": ".polis/keys",
      "posts": "articles",
      "comments": "replies",
      "versions": ".versions"
    },
    "files": {
      "public_index": "metadata/public.jsonl",
      "blessed_comments": "metadata/blessed-comments.json",
      "following_index": "metadata/following.json"
    }
  }
}
```

## JSON Mode

The Polis CLI supports a `--json` flag for machine-readable output, enabling scripting, automation, and testing workflows.

### Usage

Add `--json` before or after the command:

```bash
polis --json <command> [options]
polis <command> --json [options]   # Also works
```

### Features

When `--json` is enabled:
- **Structured output**: Valid JSON on stdout (success) or stderr (errors)
- **Auto-skip prompts**: Interactive prompts are skipped with logged defaults to stderr
- **No colors**: ANSI color codes are disabled
- **Exit codes**: 0 for success, 1 for error
- **Structured errors**: Consistent error codes (FILE_NOT_FOUND, INVALID_INPUT, API_ERROR, etc.)

### Examples

```bash
# Initialize and extract public key path
polis --json init | jq -r '.data.key_paths.public'

# Publish and get content hash
hash=$(polis --json publish my-post.md | jq -r '.data.content_hash')

# Comment with reply-to URL (no interactive prompt)
polis --json comment my-reply.md https://alice.com/posts/hello.md

# Get pending blessing requests
polis --json blessing requests | jq -r '.data.requests[].id'

# Auto-grant blessing without confirmation
polis --json blessing grant 123

# Follow author and get blessed count
polis --json follow https://alice.com | jq '.data.comments_blessed'

# Chain commands in a script
requests=$(polis --json blessing requests)
echo "$requests" | jq -r '.data.requests[].id' | while read id; do
  polis --json blessing grant "$id"
done

# Error handling
if ! result=$(polis --json publish test.md 2>&1); then
  error_code=$(echo "$result" | jq -r '.error.code')
  echo "Failed with error: $error_code"
  exit 1
fi
```

### Response Format

**Success:**
```json
{
  "status": "success",
  "command": "publish",
  "data": {
    "file_path": "posts/20260104/my-post.md",
    "content_hash": "sha256:abc123...",
    "timestamp": "2026-01-04T12:00:00Z",
    "signature": "-----BEGIN SSH SIGNATURE-----...",
    "canonical_url": "https://example.com/posts/20260104/my-post.md"
  }
}
```

**Error:**
```json
{
  "status": "error",
  "command": "publish",
  "error": {
    "code": "FILE_NOT_FOUND",
    "message": "File not found: test.md",
    "details": {}
  }
}
```

### Supported Commands

All interactive commands support JSON mode:
- `init`, `publish`, `comment`, `republish`
- `blessing requests`, `blessing grant`, `blessing deny`, `blessing beseech`
- `follow`, `unfollow`

See [docs/json-mode.md](../docs/json-mode.md) for complete documentation.

## Publishing Workflow

### 1. Write Content
```bash
vim posts/my-thoughts.md
```

### 2. Publish Locally
```bash
polis publish posts/my-thoughts.md
```

### 3. Commit to Git
```bash
git add .
git commit -m "Add: my-thoughts.md"
```

### 4. Push to Static Host
```bash
git push origin main
```

### 5. Request Blessing (if commenting)
```bash
# Note: polis comment and polis republish automatically request blessings
# You rarely need to run this manually - only for edge cases (see docs)

# If you do need to retry a blessing request:
polis blessing requests           # View pending requests
polis blessing beseech <hash>     # Retry request by hash
```

## Common Use Cases

### Creating a Blog Post
```bash
cat > posts/why-decentralization-matters.md << 'EOF'
# Why Decentralization Matters

Centralized platforms have too much control...
EOF

polis publish posts/why-decentralization-matters.md
git add . && git commit -m "New post: decentralization"
git push
```

### Replying to Someone's Post
```bash
polis comment https://alice.com/posts/20260106/hot-take.md

# Interactive editor opens - write your reply

# After saving, blessing request is automatically sent
# Your comment will be pending until the post author blesses it
```

### Updating a Post
```bash
# Edit the canonical file directly
vim posts/20260106/my-post.md

# Republish with new version
polis republish posts/20260106/my-post.md

git add . && git commit -m "Update: my-post.md"
git push
```

### Viewing Version History
```bash
# List all versions in .versions file
cat posts/20260106/.versions/my-post.md

# Reconstruct specific version
polis extract posts/20260106/my-post.md sha256:abc123...
```

## Security Notes

### Private Key Protection
- **Never commit `.polis/keys/id_ed25519`** (private key)
- Add to `.gitignore`: `.polis/keys/id_ed25519`
- Public key (`.polis/keys/id_ed25519.pub`) is safe to share

### Signature Verification
Anyone can verify your content signatures:

```bash
# Extract public key from .well-known/polis
curl https://alice.com/.well-known/polis | jq -r .public_key > alice.pub

# Verify signature (manual process - automated tool coming)
ssh-keygen -Y verify -f alice.pub -I alice@example.com -n file \
  -s signature.sig < content.txt
```

## Terminal User Interface (polis-tui)

For users who prefer a menu-based interface, polis includes a Terminal UI that wraps the CLI.

### Features

- **Dashboard** with status overview (posts, following, pending blessings)
- **Inline selection** with arrow keys or number keys
- **$EDITOR integration** for writing posts and comments
- **Git integration** with automatic commit messages and push workflow
- **HTML regeneration** prompts after content changes

### Usage

```bash
# Start the TUI
polis-tui

# Show help
polis-tui --help

# Show version
polis-tui --version
```

### Navigation

| Keys | Action |
|------|--------|
| `↑/↓` or `j/k` | Move selection up/down |
| `1-9` | Jump directly to numbered option |
| `Enter` | Confirm selection |
| `q` or `Esc` | Go back / Cancel |
| `Ctrl+C` | Exit immediately |

### Workflow Example

1. Start `polis-tui` in your initialized polis directory
2. Select "Publish new post" (arrow keys or press `1`)
3. Write your content in the editor, save and close
4. Enter a filename when prompted
5. Choose to regenerate HTML or commit to git
6. Edit the suggested commit message if needed
7. Push to remote when prompted

### Requirements

- Same dependencies as polis CLI (jq, curl, etc.)
- Polis must be initialized (`polis init`)
- `$EDITOR` environment variable (falls back to nano/vi)

## Troubleshooting

### "ssh-keygen: command not found"
Install OpenSSH client (see Installation section above).

### "jq: command not found"
Install jq JSON processor (see Installation section above).

### "pandoc is required for rendering"
Install pandoc to use `polis render`: `apt install pandoc` (Linux) or `brew install pandoc` (macOS). Pandoc is only required for the render command.

### "No such file: .polis/keys/id_ed25519"
Run `polis init` to create keys and directory structure.

### "Index file is corrupted or missing"
Run `polis rebuild` to regenerate `public.jsonl` from published files.

### Version history missing
`.versions` files are created on first `polis republish` - they don't exist for initial `polis publish`.

## Next Steps

- Read the [Architecture Documentation](../docs/polis-architecture.md) for technical details
- Set up a discovery service (see `../discovery-service/README.md`)
- Deploy your content to GitHub Pages, Netlify, or any static host
- Join the Polis community (links TBD at MVP)

## Support

For issues, questions, or feature requests, please file an issue in the GitHub repository.

## License

AGPL-3.0 - See [LICENSE](../LICENSE)
